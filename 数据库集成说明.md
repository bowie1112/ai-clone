# 🗄️ 数据库集成说明

## 概述

本项目已成功集成 **Supabase PostgreSQL** 数据库和 **Prisma ORM**，用于记录和管理视频生成历史。

---

## 🎯 核心功能

### 1. 自动记录视频生成历史
当用户在 VideoGenerator 组件生成视频时：
- ✅ 自动保存到数据库
- ✅ 记录提示词、质量、语言等
- ✅ 关联 Luma API 任务 ID
- ✅ 跟踪生成状态

### 2. Dashboard 视频历史展示
在 Dashboard 页面：
- ✅ 显示最近生成的视频
- ✅ 状态标签（已完成/处理中/失败）
- ✅ 视频缩略图和播放
- ✅ 相对时间显示
- ✅ 刷新功能

### 3. RESTful API 端点
完整的 CRUD 操作：
- ✅ 创建、查询、更新、删除视频
- ✅ 用户视频列表（分页、筛选）
- ✅ 用户统计信息

---

## 📂 新增文件结构

```
demo3/
│
├── prisma/                          # Prisma 配置
│   ├── schema.prisma               ✅ 数据库 Schema
│   └── migrations/                 ✅ 迁移文件（首次运行后生成）
│
├── lib/
│   ├── prisma.ts                   ✅ Prisma Client 单例
│   └── db/
│       └── videos.ts               ✅ 视频数据库操作函数
│
├── app/
│   ├── api/
│   │   └── videos/                 ✅ 视频 API 路由
│   │       ├── route.ts           ✅ GET, POST
│   │       ├── [id]/
│   │       │   └── route.ts       ✅ GET, PATCH, DELETE
│   │       └── stats/
│   │           └── route.ts       ✅ GET 统计
│   │
│   ├── components/
│   │   ├── VideoGenerator.tsx     ✅ 已更新（保存历史）
│   │   └── VideoHistory.tsx       ✅ 新增（显示历史）
│   │
│   └── [locale]/
│       └── dashboard/
│           └── page.tsx            ✅ 已更新（集成历史）
│
└── 文档/
    ├── SUPABASE_SETUP.md           ✅ 详细设置指南
    ├── DATABASE_QUICKSTART.md      ✅ 快速开始
    ├── ENV_TEMPLATE.md             ✅ 环境变量模板
    ├── DATABASE_完成总结.md        ✅ 完成总结
    └── 数据库集成说明.md           ✅ 本文件
```

---

## ⚡ 快速开始

### 步骤 1：创建 Supabase 项目（2 分钟）

1. 访问 https://supabase.com 并登录
2. 创建新项目，设置数据库密码
3. 等待项目初始化

### 步骤 2：配置环境变量（1 分钟）

创建 `.env` 文件：

```env
# 从 Supabase Dashboard → Settings → Database 获取
DATABASE_URL="postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:5432/postgres"
DIRECT_URL="postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:6543/postgres?pgbouncer=true"
```

### 步骤 3：运行迁移（1 分钟）

```bash
# 生成 Prisma Client
npx prisma generate

# 创建数据库表
npx prisma migrate dev --name init
```

### 步骤 4：启动应用

```bash
npm run dev
```

**完成！** 🎉

---

## 💻 使用示例

### 前端：生成视频时自动保存

```typescript
// app/components/VideoGenerator.tsx
const handleGenerate = async () => {
  // 1. 调用 Luma API
  const lumaResponse = await fetch('/api/luma/modify', {...});
  
  // 2. 自动保存到数据库
  await fetch('/api/videos', {
    method: 'POST',
    body: JSON.stringify({
      prompt: prompt,
      quality: '4k',
      locale: 'zh',
      lumaId: lumaResponse.taskId,
    }),
  });
};
```

### 前端：显示视频历史

```typescript
// app/[locale]/dashboard/page.tsx
import VideoHistory from '@/app/components/VideoHistory';

export default function Dashboard() {
  return (
    <div>
      {/* 显示最近 10 个视频 */}
      <VideoHistory limit={10} />
    </div>
  );
}
```

### 后端：数据库操作

```typescript
// lib/db/videos.ts
import { createVideo, getUserVideos, updateVideoStatus } from '@/lib/db/videos';

// 创建视频记录
const video = await createVideo({
  prompt: 'A beautiful sunset',
  quality: '4k',
  locale: 'en',
});

// 获取用户视频
const { videos, total } = await getUserVideos('user-id', {
  skip: 0,
  take: 20,
  status: 'COMPLETED',
});

// 更新状态
await updateVideoStatus(video.id, 'COMPLETED', {
  videoUrl: 'https://...',
  thumbnailUrl: 'https://...',
});
```

---

## 🔌 API 端点

### 1. 创建视频记录

```bash
POST /api/videos
Content-Type: application/json

{
  "prompt": "视频描述",
  "quality": "4k",
  "locale": "zh",
  "lumaId": "luma-task-id"
}
```

### 2. 获取视频列表

```bash
GET /api/videos?userId=xxx&status=COMPLETED&skip=0&take=20
```

### 3. 获取视频详情

```bash
GET /api/videos/[id]
```

### 4. 更新视频状态

```bash
PATCH /api/videos/[id]
Content-Type: application/json

{
  "status": "COMPLETED",
  "videoUrl": "https://...",
  "thumbnailUrl": "https://..."
}
```

### 5. 删除视频

```bash
DELETE /api/videos/[id]
```

### 6. 获取用户统计

```bash
GET /api/videos/stats?userId=xxx
```

返回：
```json
{
  "totalVideos": 24,
  "completedVideos": 20,
  "processingVideos": 2,
  "failedVideos": 2
}
```

---

## 🗄️ 数据库 Schema

### Users 表

```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  videos    Video[]
}
```

### Videos 表

```prisma
model Video {
  id           String      @id @default(cuid())
  userId       String?
  user         User?       @relation(...)
  prompt       String      @db.Text
  title        String?
  status       VideoStatus @default(PENDING)
  quality      String?
  videoUrl     String?
  thumbnailUrl String?
  lumaId       String?     @unique
  locale       String      @default("en")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  completedAt  DateTime?
}
```

### VideoStatus 枚举

```prisma
enum VideoStatus {
  PENDING     // 等待处理
  PROCESSING  // 处理中
  COMPLETED   // 完成
  FAILED      // 失败
  CANCELLED   // 取消
}
```

---

## 🛠️ 开发工具

### Prisma Studio

可视化数据库管理：

```bash
npx prisma studio
```

浏览器打开 http://localhost:5555

### 数据库迁移

```bash
# 创建新迁移
npx prisma migrate dev --name migration_name

# 应用迁移（生产）
npx prisma migrate deploy

# 重置数据库（⚠️ 删除所有数据）
npx prisma migrate reset
```

### 生成 Prisma Client

```bash
npx prisma generate
```

---

## 🔐 安全最佳实践

1. **环境变量保护**
   - ✅ `.env` 已添加到 `.gitignore`
   - ✅ 使用强密码（16+ 字符）
   - ❌ 永远不要提交密码到 Git

2. **数据访问控制**
   - ✅ API 路由进行权限检查（TODO）
   - ✅ 用户只能访问自己的数据（TODO）
   - ✅ 管理员权限分离（TODO）

3. **SQL 注入防护**
   - ✅ Prisma 自动防止 SQL 注入
   - ✅ 参数化查询

4. **连接池优化**
   - ✅ 使用 DIRECT_URL（连接池）
   - ✅ Supabase 自动管理连接

---

## 📈 性能优化

### 数据库索引

已添加索引：
- `userId` - 快速查询用户的视频
- `status` - 按状态筛选
- `createdAt` - 时间排序
- `lumaId` - Luma API 查询（唯一索引）

### 分页查询

```typescript
const { videos, total, hasMore } = await getUserVideos(userId, {
  skip: 0,    // 跳过 N 条
  take: 20,   // 取 N 条
});
```

### 连接池

使用 `DIRECT_URL`（端口 6543）通过 PgBouncer 连接池：
- 减少连接开销
- 适合无服务器环境
- 提高并发性能

---

## 🧪 测试

### 单元测试（建议添加）

```typescript
// tests/db/videos.test.ts
import { createVideo, getVideo } from '@/lib/db/videos';

test('should create video', async () => {
  const video = await createVideo({
    prompt: 'test video',
    quality: '4k',
  });
  
  expect(video.prompt).toBe('test video');
  expect(video.status).toBe('PENDING');
});
```

### API 测试

```bash
# 使用 curl 测试
./test-api.sh

# 或使用 Postman/Insomnia
```

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| [SUPABASE_SETUP.md](./SUPABASE_SETUP.md) | 详细的 Supabase 设置指南 |
| [DATABASE_QUICKSTART.md](./DATABASE_QUICKSTART.md) | 5 分钟快速开始 |
| [ENV_TEMPLATE.md](./ENV_TEMPLATE.md) | 环境变量配置模板 |
| [DATABASE_完成总结.md](./DATABASE_完成总结.md) | 完整的实施总结 |
| [prisma/schema.prisma](./prisma/schema.prisma) | Prisma Schema 文件 |
| [lib/db/videos.ts](./lib/db/videos.ts) | 数据库操作函数 |

---

## 💡 后续增强建议

### 短期（1-2 周）
1. **用户认证集成**
   - 将 Better Auth 与数据库关联
   - 基于用户的权限控制

2. **Webhook 集成**
   - Luma API 回调自动更新状态
   - 完成通知

3. **搜索功能**
   - 全文搜索提示词
   - 高级筛选

### 中期（1-2 月）
1. **数据分析**
   - 生成成功率统计
   - 用户使用趋势
   - 成本分析

2. **批量操作**
   - 批量删除
   - 批量导出

3. **缓存优化**
   - Redis 缓存热门数据
   - CDN 缓存视频

### 长期（3-6 月）
1. **高级功能**
   - 视频标签和分类
   - 收藏夹
   - 分享链接

2. **AI 辅助**
   - 提示词优化建议
   - 相似视频推荐

3. **多租户支持**
   - 团队协作
   - 权限管理

---

## 🎯 立即行动

### 开发者
1. 阅读 [DATABASE_QUICKSTART.md](./DATABASE_QUICKSTART.md)
2. 配置 Supabase 和环境变量
3. 运行迁移
4. 测试功能

### 用户
1. 访问首页生成视频
2. 查看 Dashboard 的视频历史
3. 使用筛选和刷新功能

---

**需要帮助？** 查看 [SUPABASE_SETUP.md](./SUPABASE_SETUP.md) 的常见问题部分。









